<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a2535">
<title>K√∫kovsk√© Bingo üéØ</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:        #1a2535;
  --navy2:       #1f2d3d;
  --glass:       rgba(255,255,255,0.06);
  --glass2:      rgba(255,255,255,0.11);
  --glass3:      rgba(255,255,255,0.18);
  --border:      rgba(255,255,255,0.10);
  --border2:     rgba(255,255,255,0.18);
  --green:       #27ae60;
  --green2:      #2ecc71;
  --amber:       #f39c12;
  --amber2:      #f1c40f;
  --red:         #e74c3c;
  --text:        #ecf0f1;
  --text2:       #bdc3c7;
  --muted:       #7f8c8d;
  --radius:      12px;
  --radius2:     18px;
  --shadow:      0 8px 32px rgba(0,0,0,.45);
  --font-display:'Bebas Neue', sans-serif;
  --font-body:   'Syne', sans-serif;
  --font-mono:   'DM Mono', monospace;
}

html, body {
  height: 100%; width: 100%;
  background: var(--navy);
  color: var(--text);
  font-family: var(--font-body);
  overflow: hidden;
  overscroll-behavior: none;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

/* BG */
#bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
#bg::before {
  content: ''; position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 70% 50% at 15% 15%, rgba(39,174,96,.12) 0%, transparent 55%),
    radial-gradient(ellipse 50% 40% at 85% 75%, rgba(243,156,18,.08) 0%, transparent 55%),
    radial-gradient(ellipse 80% 80% at 50% 50%, var(--navy2) 0%, var(--navy) 100%);
}
.orb { position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.18; animation: orbFloat 12s ease-in-out infinite; }
.orb1 { width: 300px; height: 300px; background: var(--green); top: -80px; left: -80px; }
.orb2 { width: 200px; height: 200px; background: var(--amber); bottom: -60px; right: -60px; animation-delay: -6s; }
@keyframes orbFloat {
  0%,100% { transform: translate(0,0) scale(1); }
  33%      { transform: translate(30px,-20px) scale(1.08); }
  66%      { transform: translate(-20px,25px) scale(.94); }
}

/* SCREENS */
.screen {
  position: fixed; inset: 0; z-index: 10;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 20px;
  transition: opacity .45s cubic-bezier(.4,0,.2,1), transform .45s cubic-bezier(.4,0,.2,1);
}
.screen.hidden { opacity: 0; pointer-events: none; transform: translateY(12px) scale(.98); }

/* SETUP */
#setup { gap: 22px; }

.logo-wrap { text-align: center; margin-bottom: 4px; }
.logo-sub { font-family: var(--font-mono); font-size: 11px; letter-spacing: 4px; color: var(--muted); text-transform: uppercase; margin-bottom: 6px; }
.logo {
  font-family: var(--font-display);
  font-size: clamp(52px, 18vw, 90px); line-height: .95; letter-spacing: 5px;
  background: linear-gradient(135deg, var(--amber) 0%, var(--amber2) 40%, var(--green2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  filter: drop-shadow(0 0 30px rgba(243,156,18,.35));
  animation: logoPulse 4s ease-in-out infinite;
}
@keyframes logoPulse {
  0%,100% { filter: drop-shadow(0 0 30px rgba(243,156,18,.35)); }
  50%      { filter: drop-shadow(0 0 50px rgba(243,156,18,.65)); }
}
.logo-tag { font-size: 12px; color: var(--muted); letter-spacing: 2px; margin-top: 4px; }

.card {
  width: 100%; max-width: 380px;
  background: var(--glass2); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--border2); border-radius: var(--radius2); padding: 24px 20px; box-shadow: var(--shadow);
}
.card label { display: block; font-size: 11px; font-weight: 600; letter-spacing: 2.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.card input {
  width: 100%; background: rgba(0,0,0,.25); border: 1.5px solid var(--border2); border-radius: var(--radius);
  padding: 13px 16px; font-family: var(--font-body); font-size: 16px; font-weight: 600; color: var(--text); outline: none;
  transition: border-color .2s, box-shadow .2s;
}
.card input::placeholder { color: var(--muted); font-weight: 400; }
.card input:focus { border-color: var(--amber); box-shadow: 0 0 0 3px rgba(243,156,18,.18); }

.ai-loader { width: 100%; max-width: 380px; }
.ai-loader-label { display: flex; justify-content: space-between; font-size: 11px; font-weight: 500; letter-spacing: 1px; color: var(--muted); margin-bottom: 7px; }
.ai-loader-label span { font-family: var(--font-mono); color: var(--amber); }
.progress-track { width: 100%; height: 5px; background: rgba(255,255,255,0.08); border-radius: 99px; overflow: hidden; }
.progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--amber), var(--green2)); border-radius: 99px; transition: width .5s ease; box-shadow: 0 0 8px rgba(243,156,18,.5); }

.btn {
  width: 100%; max-width: 380px; padding: 16px 24px; border: none; border-radius: var(--radius2);
  font-family: var(--font-display); font-size: 22px; letter-spacing: 3px;
  cursor: pointer; transition: transform .15s, box-shadow .15s, opacity .2s; position: relative; overflow: hidden;
}
.btn:active { transform: scale(.97); }
.btn-primary { background: linear-gradient(135deg, var(--amber) 0%, #e67e22 100%); color: #fff; box-shadow: 0 4px 20px rgba(243,156,18,.4); }
.btn-primary:hover { box-shadow: 0 6px 28px rgba(243,156,18,.6); }
.btn-primary:disabled { opacity: .45; cursor: not-allowed; }
.btn-secondary { background: var(--glass2); border: 1.5px solid var(--border2); color: var(--text); backdrop-filter: blur(10px); font-size: 18px; letter-spacing: 2px; }
.btn::after { content: ''; position: absolute; inset: 0; background: linear-gradient(180deg, rgba(255,255,255,.08) 0%, transparent 50%); pointer-events: none; }

/* GAME */
#game { justify-content: flex-start; padding: 0; gap: 0; }

#statusBar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  background: rgba(15,22,32,.92); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border); padding: 10px 16px; min-height: 48px;
  display: flex; align-items: center; gap: 10px;
}
#statusIcon { font-size: 18px; flex-shrink: 0; }
#statusText { font-family: var(--font-mono); font-size: 12px; color: var(--text2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#timerDisplay { font-family: var(--font-display); font-size: 20px; color: var(--amber); letter-spacing: 2px; flex-shrink: 0; }

#gameContent {
  width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center;
  padding: 58px 10px 12px; gap: 10px; overflow-y: auto; -webkit-overflow-scrolling: touch;
}

#progressWrap { width: 100%; max-width: 360px; display: flex; align-items: center; gap: 10px; }
#progressLabel { font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); white-space: nowrap; font-weight: 600; }
#progressTrack { flex: 1; height: 4px; background: rgba(255,255,255,0.08); border-radius: 99px; overflow: hidden; }
#progressFill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--green), var(--green2)); border-radius: 99px; transition: width .5s ease; }
#progressCount { font-family: var(--font-mono); font-size: 11px; color: var(--green2); white-space: nowrap; }

#grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; max-width: 360px; }

.cell {
  aspect-ratio: 1; position: relative;
  background: var(--glass); border: 1.5px solid var(--border); border-radius: 10px; overflow: hidden;
  cursor: pointer; transition: transform .18s, border-color .25s, box-shadow .25s;
  display: flex; align-items: center; justify-content: center;
  animation: cellReveal .4s cubic-bezier(.4,0,.2,1) both;
}
.cell:active { transform: scale(.93); }
.cell:not(.found):hover { border-color: var(--border2); transform: scale(.97); }
@keyframes cellReveal { from { opacity:0; transform:scale(.85) translateY(6px); } to { opacity:1; transform:scale(1) translateY(0); } }

.cell-label { font-size: clamp(7px,2vw,9.5px); font-weight: 600; color: var(--text2); text-align: center; padding: 3px; line-height: 1.3; z-index: 2; white-space: pre-line; }

.cell.found { border-color: var(--green); box-shadow: 0 0 0 1px rgba(39,174,96,.3), 0 4px 16px rgba(39,174,96,.25); }
.cell.found .cell-label { display: none; }
.cell-photo { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
.cell-check { position: absolute; top: 3px; right: 3px; z-index: 3; width: 16px; height: 16px; background: var(--green); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 9px; box-shadow: 0 2px 6px rgba(0,0,0,.4); }
.cell.found .cell-check { display: flex; }

.cell.bingo-line { border-color: var(--amber2) !important; box-shadow: 0 0 0 2px rgba(241,196,15,.5), 0 4px 20px rgba(241,196,15,.35) !important; animation: bingoCell 1.2s ease-in-out infinite !important; }
@keyframes bingoCell {
  0%,100% { box-shadow: 0 0 0 2px rgba(241,196,15,.5), 0 4px 20px rgba(241,196,15,.35); }
  50%      { box-shadow: 0 0 0 3px rgba(241,196,15,.8), 0 4px 28px rgba(241,196,15,.6); }
}
.cell.scanning { border-color: var(--amber) !important; animation: scanPulse .8s ease-in-out infinite !important; }
@keyframes scanPulse {
  0%,100% { box-shadow: 0 0 0 1px rgba(243,156,18,.3); }
  50%      { box-shadow: 0 0 0 3px rgba(243,156,18,.55); }
}

/* CAMERA */
#cameraOverlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.93); display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 14px; padding: 20px;
  transition: opacity .3s;
}
#cameraOverlay.hidden { opacity: 0; pointer-events: none; }
#videoPreview { width: 100%; max-width: 360px; aspect-ratio: 4/3; object-fit: cover; border-radius: var(--radius2); border: 2px solid var(--border2); background: #000; }
.cam-target { width: 100%; max-width: 360px; background: var(--glass2); border: 1.5px solid var(--amber); border-radius: var(--radius); padding: 10px 16px; text-align: center; }
.cam-target-label { font-size: 10px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; margin-bottom: 3px; font-family: var(--font-mono); }
.cam-target-name { font-family: var(--font-display); font-size: 28px; letter-spacing: 2px; color: var(--amber); }
.cam-buttons { width: 100%; max-width: 360px; display: flex; gap: 10px; }
.btn-capture { flex: 1; padding: 16px; border: none; border-radius: var(--radius2); background: linear-gradient(135deg, var(--green) 0%, var(--green2) 100%); color: #fff; font-family: var(--font-display); font-size: 22px; letter-spacing: 3px; cursor: pointer; box-shadow: 0 4px 20px rgba(39,174,96,.4); transition: transform .15s; }
.btn-capture:active { transform: scale(.96); }
.btn-capture:disabled { opacity: .5; cursor: not-allowed; }
.btn-close-cam { padding: 16px 20px; border: 1.5px solid var(--border2); border-radius: var(--radius2); background: var(--glass2); color: var(--text2); font-size: 22px; cursor: pointer; backdrop-filter: blur(10px); transition: transform .15s; }

/* VICTORY */
#victory { background: rgba(10,16,26,.96); backdrop-filter: blur(20px); z-index: 300; gap: 16px; }
#victory.hidden { transform: scale(.9); }
.victory-title { font-family: var(--font-display); font-size: clamp(64px,20vw,110px); letter-spacing: 6px; background: linear-gradient(135deg, var(--amber) 0%, var(--amber2) 50%, var(--green2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 40px rgba(243,156,18,.6)); text-align: center; }
.victory-card { width: 100%; max-width: 360px; background: var(--glass2); border: 1.5px solid var(--border2); border-radius: var(--radius2); padding: 20px; text-align: center; }

#toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
  z-index: 500; background: var(--glass3); backdrop-filter: blur(16px);
  border: 1px solid var(--border2); border-radius: var(--radius);
  padding: 12px 20px; font-size: 13px; color: var(--text);
  opacity: 0; transition: opacity .3s, transform .3s; pointer-events: none;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

#snapCanvas { display: none; }
#confettiCanvas { position: fixed; inset: 0; z-index: 290; pointer-events: none; }
</style>
</head>
<body>

<div id="bg"><div class="orb orb1"></div><div class="orb orb2"></div></div>

<div class="screen" id="setup">
  <div class="logo-wrap">
    <div class="logo-sub">Vonkaj≈°ia hra</div>
    <div class="logo">K√öKOVSK√â<br>BINGO</div>
    <div class="logo-tag">Outdoor Scavenger Hunt ¬∑ AI Edition</div>
  </div>

  <div class="card">
    <label for="playerName">Meno hr√°ƒça</label>
    <input type="text" id="playerName" placeholder="Zadaj svoje meno‚Ä¶" maxlength="30" autocomplete="off">
  </div>

  <div class="ai-loader">
    <div class="ai-loader-label">
      <span>ü§ñ Naƒç√≠tavam AI model</span>
      <span id="aiPercent">0%</span>
    </div>
    <div class="progress-track"><div class="progress-bar" id="aiProgress"></div></div>
  </div>

  <button class="btn btn-primary" id="startBtn" disabled onclick="handleStartBtn()">NAƒå√çTAVAM‚Ä¶</button>
  <button class="btn btn-secondary" id="continueBtn" style="display:none" onclick="continueGame()">‚ñ∂ POKRAƒåOVA≈§</button>
</div>

<div class="screen hidden" id="game">
  <div id="statusBar">
    <span id="statusIcon">üéØ</span>
    <span id="statusText">≈§ukni na pol√≠ƒçko a odfotografuj predmet</span>
    <span id="timerDisplay">0:00</span>
  </div>
  <div id="gameContent">
    <div id="progressWrap">
      <span id="progressLabel">N√°jden√©</span>
      <div id="progressTrack"><div id="progressFill"></div></div>
      <span id="progressCount">0 / 25</span>
    </div>
    <div id="grid"></div>
  </div>
</div>

<div id="cameraOverlay" class="hidden">
  <video id="videoPreview" playsinline autoplay muted></video>
  <div class="cam-target">
    <div class="cam-target-label">Fotografuje≈°</div>
    <div class="cam-target-name" id="camTargetName">‚Äî</div>
  </div>
  <div class="cam-buttons">
    <button class="btn-capture" id="captureBtn" onclick="capturePhoto()">üì∏ FOTI≈§</button>
    <button class="btn-close-cam" onclick="closeCamera()">‚úï</button>
  </div>
  <div id="camStatus">Pripraven√Ω na fotenie</div>
</div>
<canvas id="snapCanvas"></canvas>

<div class="screen hidden" id="victory">
  <div class="victory-title">BINGO!</div>
  <div class="victory-card">
    <div id="victoryName" style="font-size: 24px; color: var(--amber);">‚Äî</div>
    <div id="victoryTime" style="font-size: 52px; font-family: var(--font-display);">0:00</div>
    <div id="victoryEmailStatus" style="font-size: 11px; color: var(--muted);">üìß Odosielam v√Ωsledok‚Ä¶</div>
  </div>
  <button class="btn btn-secondary" onclick="resetGame()" style="margin-top:20px">üîÑ NOV√Å HRA</button>
</div>

<canvas id="confettiCanvas"></canvas>
<div id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG & FIN√ÅLNE OBJEKTY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CONFIG = {
  emailjs_public_key:   '6gKohTkcBCwR_zjq6',
  emailjs_service_id:   'service_lgyn3eh',
  emailjs_template_id:  'template_3f2051q',
  threshold:            0.10,
  autoSaveInterval:     5000,
  offlineRetryInterval: 30000,
};

const ALL_ITEMS = [
  { sk:'Kladivo', emoji:'üî®', keywords:['hammer', 'mallet'] },
  { sk:'Visiaci z√°mok', emoji:'üîí', keywords:['padlock', 'lock', 'combination lock'] },
  { sk:'Kosaƒçka', emoji:'üöú', keywords:['lawn mower', 'mower', 'tractor'] },
  { sk:'Motorov√° p√≠la', emoji:'ü™ö', keywords:['chain saw', 'chainsaw', 'power saw'] },
  { sk:'Lopata', emoji:'ü•Ñ', keywords:['shovel', 'spade', 'scoop', 'hoe'] },
  { sk:'F√∫rik', emoji:'üõí', keywords:['wheelbarrow', 'barrow', 'garden cart'] },
  { sk:'Traktor', emoji:'üöú', keywords:['tractor', 'thresher', 'farm machine', 'harvester'] },
  { sk:'Krhlina', emoji:'üöø', keywords:['watering can', 'water pot', 'pitcher'] },
  { sk:'Vedro', emoji:'ü™£', keywords:['bucket', 'pail', 'barrel', 'tub'] },
  { sk:'Rebr√≠k', emoji:'ü™ú', keywords:['ladder', 'step ladder', 'fire escape'] },
  { sk:'Vlƒçiak', emoji:'üêï', keywords:['German shepherd', 'German shepherd dog', 'police dog', 'dog', 'alsatian'] },
  { sk:'Maƒçka', emoji:'üê±', keywords:['tabby', 'tiger cat', 'cat', 'kitten'] },
  { sk:'Sliepka', emoji:'üêî', keywords:['hen', 'cock', 'rooster', 'chicken', 'fowl'] },
  { sk:'Dreven√Ω plot', emoji:'ü™µ', keywords:['picket fence', 'worm fence', 'rail fence', 'fence'] },
  { sk:'Poleno / Drevo', emoji:'ü™µ', keywords:['log', 'firewood', 'timber', 'lumber'] },
  { sk:'Laviƒçka', emoji:'ü™ë', keywords:['park bench', 'bench', 'seat'] },
  { sk:'Kvetin√°ƒç', emoji:'ü™¥', keywords:['pot', 'flowerpot', 'vase'] },
  { sk:'Sud', emoji:'üõ¢Ô∏è', keywords:['barrel', 'cask', 'water barrel', 'drum'] },
  { sk:'Metla', emoji:'üßπ', keywords:['broom', 'mop', 'swab'] },
  { sk:'Bicykel', emoji:'üö≤', keywords:['bicycle-built-for-two', 'tandem bicycle', 'mountain bike', 'bike', 'bicycle'] },
  { sk:'Pneumatika', emoji:'‚≠ï', keywords:['tire', 'tyre', 'car wheel', 'wheel'] },
  { sk:'Schody', emoji:'ü™ú', keywords:['staircase', 'stairway', 'steps'] },
  { sk:'Hydrant', emoji:'üö®', keywords:['fire hydrant', 'fireplug', 'hydrant'] },
  { sk:'Po≈°tov√° schr√°nka', emoji:'üì¨', keywords:['mailbox', 'letterbox', 'mail slot'] },
  { sk:'Smetiak', emoji:'üóëÔ∏è', keywords:['trash can', 'garbage can', 'wastebin', 'ashcan', 'recycling bin'] }
];

let model = null;
let gameState = null;
let timerHandle = null;
let autoSaveHdl = null;
let videoStream = null;
let activeCellIdx = null;

async function initApp() {
  emailjs.init(CONFIG.emailjs_public_key);
  const saved = loadSavedGame();
  if (saved) document.getElementById('continueBtn').style.display = 'flex';

  try {
    model = await mobilenet.load({ version: 2, alpha: 1.0 });
    document.getElementById('aiProgress').style.width = '100%';
    document.getElementById('aiPercent').textContent = '100%';
    const btn = document.getElementById('startBtn');
    btn.disabled = false;
    btn.textContent = '‚ñ∂ ZAƒåA≈§ HRU';
  } catch(err) { toast('‚ùå Chyba naƒç√≠tania AI.'); }
}

function handleStartBtn() {
  const name = document.getElementById('playerName').value.trim();
  if (!name) { toast('üë§ Zadaj svoje meno!'); return; }
  
  // PRIDAN√ù ALERT S IN≈†TRUKCIAMI
  alert("Rada pre hr√°ƒça:\n\nKeƒè fot√≠≈° predmet, sna≈æ sa, aby bol dobre osvetlen√Ω, v strede z√°beru a neh√Ωb sa, k√Ωm AI analyzuje fotku. Ak ho AI na prv√Ωkr√°t nepozn√°, sk√∫s zmeni≈• uhol!");

  const shuffled = [...ALL_ITEMS].sort(() => Math.random() - 0.5);
  gameState = { player: name, grid: shuffled, found: new Set(), startTime: Date.now(), bingoAchieved: false };
  startNewGame();
}

function startNewGame() {
  renderBoard();
  showScreen('game');
  startTimer();
  startAutoSave();
}

function continueGame() {
  const saved = loadSavedGame();
  saved.found = new Set(saved.found || []);
  gameState = saved;
  renderBoard();
  showScreen('game');
  startTimer();
  startAutoSave();
}

function renderBoard() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  gameState.grid.forEach((item, idx) => {
    const cell = document.createElement('div');
    cell.className = 'cell' + (gameState.found.has(idx) ? ' found' : '');
    if (gameState.found.has(idx)) {
      const img = document.createElement('img');
      img.className = 'cell-photo';
      img.src = localStorage.getItem(`bingo_photo_${gameState.player}_${idx}`);
      cell.appendChild(img);
      const chk = document.createElement('div'); chk.className = 'cell-check'; chk.textContent = '‚úì'; cell.appendChild(chk);
    } else {
      cell.innerHTML = `<div class="cell-label">${item.emoji}\n${item.sk}</div>`;
      cell.onclick = () => openCamera(idx);
    }
    grid.appendChild(cell);
  });
  updateProgress();
  highlightBingoLines();
}

async function openCamera(idx) {
  activeCellIdx = idx;
  document.getElementById('camTargetName').textContent = gameState.grid[idx].sk;
  document.getElementById('cameraOverlay').classList.remove('hidden');
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById('videoPreview').srcObject = videoStream;
  } catch(e) { toast('‚ùå Kamera nedostupn√°.'); }
}

function closeCamera() {
  if (videoStream) videoStream.getTracks().forEach(t => t.stop());
  document.getElementById('cameraOverlay').classList.add('hidden');
}

async function capturePhoto() {
  const video = document.getElementById('videoPreview');
  const canvas = document.getElementById('snapCanvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  document.getElementById('camStatus').textContent = "üîç AI analyzuje...";
  const preds = await model.classify(canvas);
  const item = gameState.grid[activeCellIdx];

  const found = preds.some(p => p.probability >= CONFIG.threshold && item.keywords.some(k => p.className.toLowerCase().includes(k.toLowerCase())));

  if (found) {
    const data = canvas.toDataURL('image/jpeg', 0.6);
    localStorage.setItem(`bingo_photo_${gameState.player}_${activeCellIdx}`, data);
    gameState.found.add(activeCellIdx);
    saveGame();
    closeCamera();
    renderBoard();
    if (!gameState.bingoAchieved && checkBingo()) {
      gameState.bingoAchieved = true;
      celebrate();
    }
  } else {
    document.getElementById('camStatus').textContent = "‚ùå AI vid√≠: " + preds[0].className;
  }
}

function checkBingo() {
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  return lines.some(l => l.every(i => gameState.found.has(i)));
}

function celebrate() {
  clearInterval(timerHandle);
  const timeStr = document.getElementById('timerDisplay').textContent;
  document.getElementById('victoryName').textContent = gameState.player;
  document.getElementById('victoryTime').textContent = timeStr;
  showScreen('victory');
  launchConfetti();
  emailjs.send(CONFIG.emailjs_service_id, CONFIG.emailjs_template_id, { player_name: gameState.player, finish_time: timeStr });
}

function startTimer() {
  timerHandle = setInterval(() => {
    const s = Math.floor((Date.now() - gameState.startTime) / 1000);
    document.getElementById('timerDisplay').textContent = Math.floor(s/60) + ":" + String(s%60).padStart(2,'0');
  }, 1000);
}

function updateProgress() {
  const c = gameState.found.size;
  document.getElementById('progressCount').textContent = c + ' / 25';
  document.getElementById('progressFill').style.width = (c / 25 * 100) + '%';
}

function highlightBingoLines() {
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  lines.forEach(line => {
    if (line.every(i => gameState.found.has(i))) {
      line.forEach(i => document.getElementById(`cell-${i}`)?.classList.add('bingo-line'));
    }
  });
}

function startAutoSave() { autoSaveHdl = setInterval(saveGame, CONFIG.autoSaveInterval); }
function saveGame() { if(gameState) localStorage.setItem('kukovske_bingo_save', JSON.stringify({ ...gameState, found: [...gameState.found] })); }
function loadSavedGame() { return JSON.parse(localStorage.getItem('kukovske_bingo_save')); }
function resetGame() { localStorage.removeItem('kukovske_bingo_save'); location.reload(); }
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.toggle('hidden', s.id !== id)); }
function toast(m) { const e = document.getElementById('toast'); e.textContent = m; e.classList.add('show'); setTimeout(() => e.classList.remove('show'), 3000); }

/* CONFETTI LOGIC */
let _cr=false;
function launchConfetti() {
  const cv=document.getElementById('confettiCanvas'); cv.width=innerWidth; cv.height=innerHeight;
  const ctx=cv.getContext('2d'); _cr=true;
  const ps=Array.from({length:100},()=>({x:Math.random()*cv.width,y:Math.random()*cv.height-cv.height,r:Math.random()*6+2,d:Math.random()*3+1,c:'#'+(Math.random()*0xFFFFFF<<0).toString(16)}));
  (function F(){ if(!_cr)return; ctx.clearRect(0,0,cv.width,cv.height); ps.forEach(p=>{ctx.fillStyle=p.c;ctx.fillRect(p.x,p.y,p.r,p.r);p.y+=p.d;if(p.y>cv.height)p.y=-10;}); requestAnimationFrame(F); })();
}

window.onload = initApp;
</script>
</body>
</html>
