<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dedinsk√© Bingo üéØ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary: #27ae60;
            --accent: #f39c12;
            --dark: #1a2535;
            --bg: #ffffff;
        }

        body { 
            font-family: sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
            color: #333;
        }
        
        /* --- √öPLNE JEDNODUCH√ù VIZU√ÅL (Podƒæa fotky) --- */
        h1 { font-size: 28px; margin-bottom: 5px; font-weight: bold; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }

        #setup { width: 100%; max-width: 350px; text-align: center; }
        input { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid #ccc; border-radius: 5px; font-size: 16px; 
            box-sizing: border-box;
        }
        .btn-start { 
            background: var(--primary); color: white; border: none; 
            padding: 15px; border-radius: 5px; cursor: pointer; 
            font-size: 18px; font-weight: bold; width: 100%; 
        }
        .btn-start:disabled { background: #ccc; }

        /* --- MRIE≈ΩKA --- */
        #timer { font-size: 32px; font-weight: bold; margin-bottom: 20px; font-family: monospace; }
        #grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 5px; width: 100%; max-width: 400px; 
        }
        .cell { 
            aspect-ratio: 1; background: #fff; border: 1px solid #ddd; 
            border-radius: 4px; display: flex; align-items: center; 
            justify-content: center; font-size: 8px; font-weight: bold; 
            text-align: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .cell.found { border-color: var(--primary); background: #e8f5e9; }
        .cell img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        .cell span { z-index: 2; padding: 2px; }

        /* --- TEN "DOS≈§ DOBR√ù" FO≈§√ÅK (Tmav√Ω ≈°t√Ωl) --- */
        #cameraOverlay { 
            position: fixed; inset: 0; background: var(--dark); z-index: 1000; 
            display: none; flex-direction: column; align-items: center; justify-content: space-between; 
            padding: 40px 20px; color: white;
        }
        .target-label { background: rgba(255,255,255,0.1); border-left: 4px solid var(--accent); padding: 10px 20px; width: 80%; }
        .target-label small { color: #aaa; text-transform: uppercase; font-size: 10px; letter-spacing: 1px; }
        .target-label h2 { margin: 0; color: var(--accent); }

        .video-box { position: relative; width: 100%; max-width: 320px; aspect-ratio: 1; border-radius: 15px; overflow: hidden; border: 2px solid #444; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: var(--accent); top: 0; animation: scan 2s linear infinite; box-shadow: 0 0 10px var(--accent); }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .cam-ui { text-align: center; width: 100%; }
        #aiStatus { font-size: 14px; color: #ccc; margin-bottom: 20px; min-height: 40px; }
        #aiStatus b { color: var(--accent); }
        
        .cam-btns { display: flex; gap: 10px; width: 100%; max-width: 320px; margin: 0 auto; }
        .btn-capture { flex: 3; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 10px; font-size: 18px; font-weight: bold; }
        .btn-close { flex: 1; background: #333; color: white; border: none; border-radius: 10px; font-size: 20px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>Dedinsk√© Bingo üéØ</h1>
    <div class="subtitle">N√°jdi predmety z mrie≈æky v okol√≠</div>

    <div id="setup">
        <input type="text" id="playerName" placeholder="Zadaj svoje meno...">
        <div id="loadingMsg" style="font-size: 12px; color: #999; margin-bottom: 10px;">Pripravujem AI...</div>
        <button id="startBtn" class="btn-start" disabled onclick="startGame()">ZAƒåA≈§ HRU</button>
    </div>

    <div id="game" class="hidden">
        <div id="timer" style="text-align: center;">0:00</div>
        <div id="grid"></div>
        <p style="text-align: center; color: #999; font-size: 12px; margin-top: 20px;" onclick="location.reload()">Resetova≈• hru</p>
    </div>

    <div id="cameraOverlay">
        <div class="target-label">
            <small>Aktu√°lne hƒæad√°≈°:</small>
            <h2 id="targetName">Predmet</h2>
        </div>

        <div class="video-box">
            <video id="video" playsinline autoplay muted></video>
            <div class="scan-line"></div>
        </div>

        <div class="cam-ui">
            <div id="aiStatus">Zamier na predmet...</div>
            <div class="cam-btns">
                <button class="btn-capture" onclick="takePhoto()">üì∏ ANALYZOVA≈§</button>
                <button class="btn-close" onclick="closeCamera()">‚úï</button>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

<script>
    const CONFIG = {
        emailjs_service: 'service_lgyn3eh',
        emailjs_template: 'template_3f2051q',
        emailjs_user: '6gKohTkcBCwR_zjq6'
    };

    const ITEMS = [
        { sk:'Kladivo', keywords:['hammer', 'mallet'] },
        { sk:'Visiaci z√°mok', keywords:['padlock', 'lock'] },
        { sk:'Kosaƒçka', keywords:['lawn mower', 'mower', 'tractor'] },
        { sk:'Motorov√° p√≠la', keywords:['chain saw', 'chainsaw'] },
        { sk:'Lopata', keywords:['shovel', 'spade'] },
        { sk:'F√∫rik', keywords:['wheelbarrow', 'barrow'] },
        { sk:'Traktor', keywords:['tractor', 'thresher'] },
        { sk:'Krhlina', keywords:['watering can', 'pitcher'] },
        { sk:'Vedro', keywords:['bucket', 'pail'] },
        { sk:'Rebr√≠k', keywords:['ladder', 'step ladder'] },
        { sk:'Vlƒçiak', keywords:['German shepherd', 'dog'] },
        { sk:'Maƒçka', keywords:['cat', 'tabby'] },
        { sk:'Sliepka', keywords:['hen', 'rooster', 'chicken'] },
        { sk:'Dreven√Ω plot', keywords:['picket fence', 'fence'] },
        { sk:'Poleno', keywords:['log', 'firewood', 'timber'] },
        { sk:'Laviƒçka', keywords:['bench'] },
        { sk:'Kvetin√°ƒç', keywords:['pot', 'flowerpot'] },
        { sk:'Sud', keywords:['barrel', 'drum'] },
        { sk:'Metla', keywords:['broom', 'mop'] },
        { sk:'Bicykel', keywords:['bicycle', 'bike'] },
        { sk:'Pneumatika', keywords:['tire', 'tyre', 'wheel'] },
        { sk:'Schody', keywords:['staircase', 'steps'] },
        { sk:'Hydrant', keywords:['fire hydrant', 'hydrant'] },
        { sk:'Po≈°tov√° schr√°nka', keywords:['mailbox', 'postbox'] },
        { sk:'Smetiak', keywords:['trash can', 'garbage can'] }
    ];

    let model, gameState, videoStream, activeIdx;

    async function init() {
        emailjs.init(CONFIG.emailjs_user);
        model = await mobilenet.load();
        document.getElementById('loadingMsg').innerText = "‚úÖ AI Pripraven√©";
        document.getElementById('startBtn').disabled = false;
    }

    function startGame() {
        const name = document.getElementById('playerName').value;
        if(!name) return alert("Zadaj meno!");

        gameState = {
            player: name,
            grid: [...ITEMS].sort(() => Math.random() - 0.5),
            found: [],
            startTime: Date.now()
        };

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        renderGrid();
        startTimer();
    }

    function renderGrid() {
        const gridDiv = document.getElementById('grid');
        gridDiv.innerHTML = '';
        gameState.grid.forEach((item, i) => {
            const cell = document.createElement('div');
            cell.className = 'cell' + (gameState.found.includes(i) ? ' found' : '');
            if(gameState.found.includes(i)) {
                const imgData = localStorage.getItem(`photo_${gameState.player}_${i}`);
                cell.innerHTML = imgData ? `<img src="${imgData}">` : `<span>‚úÖ</span>`;
            } else {
                cell.innerHTML = `<span>${item.sk}</span>`;
                cell.onclick = () => openCamera(i);
            }
            gridDiv.appendChild(cell);
        });
    }

    async function openCamera(i) {
        activeIdx = i;
        document.getElementById('targetName').innerText = gameState.grid[i].sk;
        document.getElementById('cameraOverlay').style.display = 'flex';
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = videoStream;
    }

    async function takePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        document.getElementById('aiStatus').innerText = "üîç Analyzujem...";
        const predictions = await model.classify(canvas);
        
        const top = predictions[0];
        const percent = Math.round(top.probability * 100);
        document.getElementById('aiStatus').innerHTML = `AI vid√≠: <b>${top.className}</b> (${percent}%)`;

        const item = gameState.grid[activeIdx];
        const match = predictions.some(p => 
            p.probability > 0.08 && item.keywords.some(k => p.className.toLowerCase().includes(k.toLowerCase()))
        );

        if(match) {
            document.getElementById('aiStatus').innerHTML = "<b style='color:#27ae60;'>ZHODA N√ÅJDEN√Å!</b>";
            setTimeout(() => {
                localStorage.setItem(`photo_${gameState.player}_${activeIdx}`, canvas.toDataURL('image/jpeg', 0.5));
                gameState.found.push(activeIdx);
                closeCamera();
                renderGrid();
                checkWin();
            }, 800);
        }
    }

    function closeCamera() {
        if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        document.getElementById('cameraOverlay').style.display = 'none';
        document.getElementById('aiStatus').innerText = "Zamier na predmet...";
    }

    function checkWin() {
        const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        if(lines.some(line => line.every(idx => gameState.found.includes(idx)))) {
            const time = document.getElementById('timer').innerText;
            alert(`BINGO! Hr√°ƒç ${gameState.player} vyhral v ƒçase ${time}!`);
            emailjs.send(CONFIG.emailjs_service, CONFIG.emailjs_template, { player_name: gameState.player, finish_time: time });
        }
    }

    function startTimer() {
        setInterval(() => {
            const diff = Math.floor((Date.now() - gameState.startTime) / 1000);
            document.getElementById('timer').innerText = Math.floor(diff/60) + ":" + String(diff%60).padStart(2,'0');
        }, 1000);
    }

    init();
</script>
</body>
</html>
