<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dedinsk√© Bingo üéØ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary: #27ae60;
            --accent: #f39c12;
            --dark: #1a2535;
            --bg: #ffffff; /* Biely mot√≠v */
            --card-bg: #fdfdfd;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; color: var(--dark); }
        
        /* BIELY MOT√çV (Menu a Mrie≈æka) */
        .card { background: var(--card-bg); padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; margin-top: 20px; border: 1px solid #eee; }
        input { width: 90%; padding: 14px; margin: 15px 0; border: 2px solid #eee; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.3s; }
        input:focus { border-color: var(--primary); }
        .btn-start { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: bold; width: 100%; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2); }
        
        /* BINGO MRIE≈ΩKA */
        #grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 450px; margin-top: 20px; }
        .cell { aspect-ratio: 1; background: white; border: 1px solid #e0e0e0; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 8.5px; font-weight: 700; text-align: center; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.1s; }
        .cell:active { transform: scale(0.95); }
        .cell.found { border: 2px solid var(--primary); background: #fafffb; }
        .cell img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .cell span { z-index: 2; padding: 2px 4px; background: rgba(255,255,255,0.85); border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-transform: uppercase; }

        /* --- TMAV√ù CUSTOM FO≈§√ÅK (Claude Style) --- */
        #cameraOverlay { 
            position: fixed; inset: 0; background: var(--dark); z-index: 1000; 
            display: none; flex-direction: column; align-items: center; justify-content: space-between; 
            padding: 40px 20px; color: white;
        }
        .target-box { background: rgba(255,255,255,0.08); border: 1px solid var(--accent); padding: 12px 25px; border-radius: 15px; text-align: center; width: 80%; }
        .target-box span { font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 2px; }
        .target-box h2 { margin: 5px 0; color: var(--accent); font-size: 26px; font-weight: 800; }

        .video-container { position: relative; width: 100%; max-width: 340px; aspect-ratio: 1; border-radius: 25px; overflow: hidden; border: 3px solid rgba(255,255,255,0.1); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; width: 100%; height: 3px; background: var(--accent); top: 0; left: 0; box-shadow: 0 0 15px var(--accent); animation: scan 2.5s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .cam-footer { width: 100%; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        #aiStatus { font-size: 14px; color: #bbb; text-align: center; min-height: 40px; padding: 0 20px; line-height: 1.4; }
        #aiStatus b { color: var(--accent); font-family: monospace; }
        
        .cam-btns { display: flex; gap: 15px; width: 100%; max-width: 340px; }
        .btn-capture { flex: 2; background: var(--primary); color: white; border: none; padding: 20px; border-radius: 18px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(39,174,96,0.3); }
        .btn-close { flex: 1; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; font-size: 22px; cursor: pointer; }

        #timer { font-size: 28px; font-weight: 800; color: var(--primary); margin: 10px; font-family: 'Courier New', monospace; background: #eee; padding: 5px 20px; border-radius: 30px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1 style="font-weight: 900; letter-spacing: -1px; margin-bottom: 0;">Dedinsk√© Bingo üéØ</h1>
    <p style="color: #888; margin-top: 5px; font-size: 14px;">N√°jdi predmety v okol√≠ a z√≠skaj Bingo!</p>

    <div id="setup" class="card">
        <input type="text" id="playerName" placeholder="Zadaj svoje meno...">
        <p id="loadingMsg" style="font-size: 13px; color: #aaa; margin-bottom: 20px;">ü§ñ Preb√∫dzam AI neur√≥nov√∫ sie≈•...</p>
        <button id="startBtn" class="btn-start" disabled onclick="startGame()">ZAƒåA≈§ DOBRODRU≈ΩSTVO</button>
    </div>

    <div id="game" class="hidden" style="text-align: center; width: 100%;">
        <div id="timer">0:00</div>
        <div id="grid"></div>
        <button onclick="location.reload()" style="background:none; border:none; color:#bbb; margin-top:40px; cursor:pointer; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Vynulova≈• hru</button>
    </div>

    <div id="cameraOverlay">
        <div class="target-box">
            <span>Zameraj sa na</span>
            <h2 id="targetName">Predmet</h2>
        </div>

        <div class="video-container">
            <video id="video" playsinline autoplay muted></video>
            <div class="scan-line"></div>
        </div>

        <div class="cam-footer">
            <div id="aiStatus">Pripraven√Ω na anal√Ωzu...</div>
            <div class="cam-btns">
                <button class="btn-capture" onclick="takePhoto()">üì∏ ANALYZOVA≈§</button>
                <button class="btn-close" onclick="closeCamera()">‚úï</button>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

<script>
    const CONFIG = {
        emailjs_service: 'service_lgyn3eh',
        emailjs_template: 'template_3f2051q',
        emailjs_user: '6gKohTkcBCwR_zjq6'
    };

    // TVOJICH 25 FIN√ÅLNYCH OBJEKTOV
    const ITEMS = [
        { sk:'Kladivo', keywords:['hammer', 'mallet'] },
        { sk:'Visiaci z√°mok', keywords:['padlock', 'lock'] },
        { sk:'Kosaƒçka', keywords:['lawn mower', 'mower', 'tractor'] },
        { sk:'Motorov√° p√≠la', keywords:['chain saw', 'chainsaw'] },
        { sk:'Lopata', keywords:['shovel', 'spade'] },
        { sk:'F√∫rik', keywords:['wheelbarrow', 'barrow'] },
        { sk:'Traktor', keywords:['tractor', 'thresher'] },
        { sk:'Krhlina', keywords:['watering can', 'pitcher'] },
        { sk:'Vedro', keywords:['bucket', 'pail'] },
        { sk:'Rebr√≠k', keywords:['ladder', 'step ladder'] },
        { sk:'Vlƒçiak', keywords:['German shepherd', 'dog'] },
        { sk:'Maƒçka', keywords:['cat', 'tabby'] },
        { sk:'Sliepka', keywords:['hen', 'rooster', 'chicken'] },
        { sk:'Dreven√Ω plot', keywords:['picket fence', 'fence'] },
        { sk:'Poleno', keywords:['log', 'firewood', 'timber'] },
        { sk:'Laviƒçka', keywords:['bench'] },
        { sk:'Kvetin√°ƒç', keywords:['pot', 'flowerpot'] },
        { sk:'Sud', keywords:['barrel', 'drum'] },
        { sk:'Metla', keywords:['broom', 'mop'] },
        { sk:'Bicykel', keywords:['bicycle', 'bike'] },
        { sk:'Pneumatika', keywords:['tire', 'tyre', 'wheel'] },
        { sk:'Schody', keywords:['staircase', 'steps'] },
        { sk:'Hydrant', keywords:['fire hydrant', 'hydrant'] },
        { sk:'Po≈°tov√° schr√°nka', keywords:['mailbox', 'postbox'] },
        { sk:'Smetiak', keywords:['trash can', 'garbage can'] }
    ];

    let model, gameState, videoStream, activeIdx;

    async function init() {
        emailjs.init(CONFIG.emailjs_user);
        model = await mobilenet.load();
        document.getElementById('loadingMsg').innerHTML = "‚úÖ AI Siet je pripraven√°!";
        document.getElementById('startBtn').disabled = false;
    }

    function startGame() {
        const name = document.getElementById('playerName').value;
        if(!name) return alert("Pros√≠m, zadaj svoje meno.");

        alert("RADY PRE HR√ÅƒåA:\n1. Fo≈• zbl√≠zka.\n2. Dr≈æ telef√≥n pevne.\n3. Uisti sa, ≈æe je dobr√© svetlo.");

        gameState = {
            player: name,
            grid: [...ITEMS].sort(() => Math.random() - 0.5),
            found: [],
            startTime: Date.now()
        };

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game').classList.remove('hidden');
        renderGrid();
        startTimer();
    }

    function renderGrid() {
        const gridDiv = document.getElementById('grid');
        gridDiv.innerHTML = '';
        gameState.grid.forEach((item, i) => {
            const cell = document.createElement('div');
            cell.className = 'cell' + (gameState.found.includes(i) ? ' found' : '');
            
            if(gameState.found.includes(i)) {
                const imgData = localStorage.getItem(`photo_${gameState.player}_${i}`);
                cell.innerHTML = imgData ? `<img src="${imgData}">` : `<span>‚úÖ</span>`;
            } else {
                cell.innerHTML = `<span>${item.sk}</span>`;
                cell.onclick = () => openCamera(i);
            }
            gridDiv.appendChild(cell);
        });
    }

    async function openCamera(i) {
        activeIdx = i;
        document.getElementById('targetName').innerText = gameState.grid[i].sk;
        document.getElementById('cameraOverlay').style.display = 'flex';
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = videoStream;
        } catch(e) { alert("Nepodarilo sa spusti≈• kameru."); }
    }

    async function takePhoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        document.getElementById('aiStatus').innerText = "üîç Analyzujem obraz...";
        const predictions = await model.classify(canvas);
        
        // Zobrazenie toho, ƒço AI vid√≠
        const top = predictions[0];
        const percent = Math.round(top.probability * 100);
        document.getElementById('aiStatus').innerHTML = `AI vid√≠: <b>${top.className}</b><br>Istota: <b>${percent}%</b>`;

        const item = gameState.grid[activeIdx];
        const match = predictions.some(p => 
            p.probability > 0.08 && item.keywords.some(k => p.className.toLowerCase().includes(k.toLowerCase()))
        );

        if(match) {
            document.getElementById('aiStatus').innerHTML = "<b style='color:#27ae60;'>‚úÖ ZHODA N√ÅJDEN√Å!</b>";
            setTimeout(() => {
                localStorage.setItem(`photo_${gameState.player}_${activeIdx}`, canvas.toDataURL('image/jpeg', 0.5));
                gameState.found.push(activeIdx);
                closeCamera();
                renderGrid();
                checkWin();
            }, 800);
        } else {
            // Ak sa netraf√≠, nech√°me status chv√≠ƒæu svieti≈•, aby si hr√°ƒç preƒç√≠tal %
        }
    }

    function closeCamera() {
        if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        document.getElementById('cameraOverlay').style.display = 'none';
        document.getElementById('aiStatus').innerText = "Pripraven√Ω na anal√Ωzu...";
    }

    function checkWin() {
        const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        const bingo = lines.some(line => line.every(idx => gameState.found.includes(idx)));

        if(bingo) {
            const time = document.getElementById('timer').innerText;
            alert(`üéâ GRATULUJEME! Dosiahol si BINGO v ƒçase ${time}. V√Ωsledok bol odoslan√Ω.`);
            emailjs.send(CONFIG.emailjs_service, CONFIG.emailjs_template, {
                player_name: gameState.player,
                finish_time: time
            });
        }
    }

    function startTimer() {
        setInterval(() => {
            const diff = Math.floor((Date.now() - gameState.startTime) / 1000);
            document.getElementById('timer').innerText = Math.floor(diff/60) + ":" + String(diff%60).padStart(2,'0');
        }, 1000);
    }

    init();
</script>
</body>
</html>
